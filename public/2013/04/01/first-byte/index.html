
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>First Byte - The Technician</title>
	<meta name="author" content="Chris Henry">

	
	<meta name="description" content="As we all may have some idea of at this point, performance on the web is one of the keys to success. However, finding actionable performance metrics &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="The Technician" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script async="true" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">The Technician</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:chr.ishenry.com">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		<a class="twitter" href="http://twitter.com/chrishnry" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/chrishenry" title="GitHub">GitHub</a>
		
    
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
    
		
		<a class="feedly" title="Feedly" href="http://cloud.feedly.com/#subscription%2Ffeed%2Fhttp%3A%2F%2Fchr.ishenry.com%2Fatom.xml" target="blank">Feedly</a>
		
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:chr.ishenry.com">
	</form>
</nav>

</header>
	<div id="content" class="inner"><article class="post">
	<h2 class="title">First Byte</h2>
	<div class="entry-content"><p>As we all may have some idea of at this point, performance on the web is one of the keys to success. However, finding actionable performance metrics can be a challenge. In the course of a web request, there&#8217;s a lot of stuff that happens. I&#8217;ll briefly explain it here in a couple run-on sentences.</p>

<p>When you click on a link, your browser or client looks up the location of the server via DNS, and then sends off an HTTP request, then your poorly secured router passes it on to the demons that are your local ISP, who then fiendishly pass that same request up to a backbone, which then traverses continents, oceans or even hemispheres, finally arriving at the data center or poorly ventilated closet where the web servers for that particular site live. That web server reads in that request for your stuff (probably porn, you sicko), and begins whatever its process may be to assemble the initial HTML payload, which hopefully involves validating that the way you asked for said stuff is correct, and if it is, then connecting to a database to actually get that lovely stuff, receiving a response, and puts together an HTML page with that data on it, plus references (more on those later) to CSS and JS to format the data in a way that makes sense, and even make it look a little purty. After that exhausting operation, the web server will take the opposite route through the backbone to the succubus ISP, through your router to your computer to your browser. Once that happens, you technically only have the payload HTML, which by itself isn&#8217;t a whole lot of fun, so then the browser will read aforementioned references to CSS and JS, and then make web requests for each of those files, which, btw, will follow the same process as the initial HTML payload went through, until you have all of the CSS and JS. Then you can finally improve your mind by thoughtfully reflecting on the highly intellectual prose you requested not too long ago.</p>

<!-- more -->


<p>The point of all those horribly structured sentences in the context of web performance is that a web request will often spend more time being passed around various routers than actually being processed on a web server. Therefore, the act of measuring an entire web request is a fool&#8217;s errand, since you&#8217;re only measuring lots of things that you as a web developer don&#8217;t have any control over. In reference to my poorly written story, the only bit that you can actually change is the time when the web request is in the poorly ventilated closet, being parsed, processed, retrieved, and put together by the web server.</p>

<p>Therefore, one of the most important measurements to be recorded is the time it actually takes from when a request is received to when the server has started sending the complete result back to the client. Working on a standard LAMP (P being PHP) stack, there is no way that I&#8217;m aware of to do this out of the box. One way is to inject code into your app that will measure this, or to use a framework where this sort of functionality is built in. However, IMHO, that&#8217;s not the best approach, as it&#8217;s just more code that needs to be written, maintained, and could possibly explode in some strange way, affecting your users.</p>

<p>The approach that I&#8217;ve taken to measuring response times on the server is to use a somewhat obscure Apache module called <a href="https://code.google.com/p/mod-log-firstbyte/">mod_first_byte</a>. It&#8217;s surprisingly easy to install and run, and having run it for several weeks, I haven&#8217;t seen any performance issues or other oddities. Here&#8217;s a quick example of how to install it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># make a suitable folder to hold the source</span>
</span><span class='line'><span class="nv">install_dir</span><span class="o">=</span>mod_firstbyte
</span><span class='line'>mkdir <span class="nv">$install_dir</span>
</span><span class='line'>
</span><span class='line'><span class="c"># svn checkout the source into the install_dir</span>
</span><span class='line'>svn checkout http://mod-log-firstbyte.googlecode.com/svn/trunk/ <span class="nv">$install_dir</span>
</span><span class='line'>
</span><span class='line'><span class="c"># depending on your linux flavor, you&#39;ll need a different program to compile</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> -f /etc/issue <span class="o">]</span>
</span><span class='line'>  <span class="k">then</span>
</span><span class='line'><span class="k">  </span><span class="nv">distro</span><span class="o">=</span><span class="s1">&#39;ubuntu&#39;</span>
</span><span class='line'>  <span class="nv">apache_apxs</span><span class="o">=</span><span class="s1">&#39;apxs2&#39;</span>
</span><span class='line'>  <span class="nv">apache_conf</span><span class="o">=</span><span class="s1">&#39;/etc/apache2/apache2.conf&#39;</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> -f /etc/redhat-release <span class="o">]</span>
</span><span class='line'>  <span class="k">then</span>
</span><span class='line'><span class="k">  </span><span class="nv">distro</span><span class="o">=</span><span class="s1">&#39;redhat&#39;</span>
</span><span class='line'>  <span class="nv">apache_apxs</span><span class="o">=</span><span class="s1">&#39;apxs&#39;</span>
</span><span class='line'>  <span class="nv">apache_conf</span><span class="o">=</span><span class="s1">&#39;/etc/httpd/httpd.conf&#39;</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c"># Use the weird apache command to compile and install the apache mod</span>
</span><span class='line'><span class="nv">$apache_apxs</span> -c     <span class="nv">$install_dir</span>/mod_log_firstbyte.c
</span><span class='line'><span class="nv">$apache_apxs</span> -i -a  <span class="nv">$install_dir</span>/mod_log_firstbyte.la
</span></code></pre></td></tr></table></div></figure>


<p>Now that you&#8217;ve complied the module into an so file, you&#8217;ll need to add it to the apache conf. While you&#8217;re in there, you&#8217;ll also want to add the %F directive to your relevant LogFormat lines. Again, adjust for Linux flavor, and LogFormat preferences.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='apache'><span class='line'><span class="nb">LoadModule</span> log_firstbyte_module <span class="sx">/path/to/apache/modules/mod_log_firstbyte.so</span>
</span><span class='line'>
</span><span class='line'><span class="nb">LogFormat</span> <span class="s2">&quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %b %F&quot;</span> common
</span></code></pre></td></tr></table></div></figure>


<p>For ease of parsing, I recommend putting the %F flag at the end. I&#8217;ve been using a simple php script that runs every few seconds to grep for the last couple lines that have URLs I&#8217;m interested in measuring, pulling the %F off the end of the line, and then sending the value off to <a href="https://github.com/etsy/statsd/">statsd</a>. Keep in mind that the value of %F is in microseconds, so dividing the value by 1000 to give a more reasonable number is helpful.</p>

<p>My script looks a bit like this. What I&#8217;m attempting to do is exclude anything that seems like it&#8217;s a flat file, and only include URLs that are generated by going through my application. YMMV, depending on what your application is and what you want to measure exactly.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">$log_lines  = array();</span>
</span><span class='line'><span class="x">$cmd        = &quot;tail -n 50 /var/log/httpd/access_log | egrep -v \&quot;css|js|gif|png|jpg|jpeg\&quot;;</span>
</span><span class='line'><span class="x">$statsd_key = &quot;first_byte&quot;;</span>
</span><span class='line'>
</span><span class='line'><span class="x">exec( $cmd, $log_lines );</span>
</span><span class='line'>
</span><span class='line'><span class="x">foreach ( $log_lines as $line ) {</span>
</span><span class='line'><span class="x">  </span>
</span><span class='line'><span class="x">  $line_items = explode( &#39; &#39;, $line );</span>
</span><span class='line'>
</span><span class='line'><span class="x">  $firstbyte = $line_items[ count($line_items) - 1 ];</span>
</span><span class='line'>
</span><span class='line'><span class="x">  $firstbyte_ms = ceil( ( $firstybyte / 1000 ) );</span>
</span><span class='line'>
</span><span class='line'><span class="x">  StatsD::timing( $statsd_key, $firstybyte_ms );</span>
</span><span class='line'>
</span><span class='line'><span class="x">} // foreach log lines</span>
</span></code></pre></td></tr></table></div></figure>


<p>And voilà, you now have some very revealing graphs that will tell you exactly your app is performing, completely separate of how the hellion ISPs have decided to perform that moment. My favorite thing about these graphs is that they are an unopinionated view of how the last changes you&#8217;ve made have affected your app.</p>
</div>


<div class="meta">
	<div class="date">








  


<time datetime="2013-04-01T23:29:00-04:00" pubdate data-updated="true">Apr 1<span>st</span>, 2013</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/apache/'>apache</a>, <a class='category' href='/blog/categories/devops/'>devops</a>, <a class='category' href='/blog/categories/statsd/'>statsd</a>


</div>
	
</div>
</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
		
		<a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
		
		
		<a class="addthis_button_tweet"></a>
		
		
		
	</div>
	
</div>



<section id="comment">
    <h2 class="title">Comments</h2>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>
</div>
	<footer id="footer" class="inner">Copyright &copy; 2014

    Chris Henry

<br /><span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'thetechnician';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://chr.ishenry.com/2013/04/01/first-byte/';
        var disqus_url = 'http://chr.ishenry.com/2013/04/01/first-byte/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//go.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-6652794-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>
